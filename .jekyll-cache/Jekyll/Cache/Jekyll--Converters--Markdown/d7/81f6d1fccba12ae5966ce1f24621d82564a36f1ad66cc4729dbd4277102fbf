I"©<<ul>
  <li><a href="#å‰è¨€">å‰è¨€</a></li>
  <li><a href="#é”™è¯¯çš„ç‰ˆæœ¬">é”™è¯¯çš„ç‰ˆæœ¬</a>
    <ul>
      <li><a href="#pythonç‰ˆ">Pythonç‰ˆ</a></li>
      <li><a href="#cç‰ˆ">c++ç‰ˆ</a></li>
    </ul>
  </li>
  <li><a href="#æ”¹è¿›çš„ç‰ˆæœ¬">æ”¹è¿›çš„ç‰ˆæœ¬</a>
    <ul>
      <li><a href="#pythonç‰ˆ-1">Pythonç‰ˆ</a></li>
      <li><a href="#cç‰ˆ-1">c++ç‰ˆ</a></li>
    </ul>
  </li>
</ul>

<h1 id="å‰è¨€">å‰è¨€</h1>

<p>ä¹‹å‰åœ¨å°è±¡ç¬”è®°ä¸­å†™è¿‡ä¸€ä¸ªpython+opencvç‰ˆçš„æœ€å¤§è¿é€šåŸŸæ ‡è®°çš„ç¨‹åºï¼Œå½“æ—¶ä½¿ç”¨çš„æ˜¯opencv2ç‰ˆæœ¬ä¸­çš„findContourså‡½æ•°ä½œä¸ºè½½ä½“ï¼Œç”±äºæ²¡æœ‰åœ¨æ„findContoursä¸­çš„å„ä¸ªcontoursä¹‹é—´çš„hierarchyå…³ç³»ï¼Œåæ¥åœ¨ä¸€æ¬¡å®éªŒä¸­å‘ç°è¿™ç§æ–¹å¼æ˜¯æœ‰ä¸è¶³ä¹‹å¤„çš„ï¼Œæœ€æ–¹ä¾¿çš„è¿˜æ˜¯ä½¿ç”¨è¿é€šåŸŸæ ‡è®°ç®—æ³•å°†å›¾åƒæ ‡è®°ä¸ºå„ä¸ªè¿é€šåŸŸï¼Œç„¶ååœ¨å–è¿é€šåŸŸæœ€å¤§çš„åŒºåŸŸè¿™ç§æ–¹æ³•ã€‚</p>

<h1 id="é”™è¯¯çš„ç‰ˆæœ¬">é”™è¯¯çš„ç‰ˆæœ¬</h1>

<p>å…ˆè´´å‡ºé”™è¯¯çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªç‰ˆæœ¬çš„æƒ³æ³•æ˜¯ä½¿ç”¨findContourså‡½æ•°æ‰¾åˆ°å„ä¸ªè¿é€šåŸŸçš„contoursï¼Œç„¶åé€‰å–contoursé¢ç§¯æœ€å¤§çš„é‚£ä¸ªä½œä¸ºç›®æ ‡åŒºåŸŸï¼Œå¹¶å°†å…¶å¡«å……ã€‚findContoursä½¿ç”¨çš„æ˜¯EXTERNALçš„æ–¹å¼æ ‡è®°è¾¹ç¼˜ã€‚æ˜¾ç„¶è¿™ç§æ–¹æ³•å¦‚æœæ˜¯ä¸€ä¸ªå¤§çš„è¿é€šåŸŸé‡Œé¢æ˜¯ä¸­ç©ºçš„ï¼Œåˆ™æ ‡è®°åçš„æœ€å¤§è¿é€šåŸŸä¼šå°†ä¸­é—´ç©ºçš„éƒ¨åˆ†å¡«å……ä¸Šï¼Œå› æ­¤å‡ºé”™ã€‚</p>

<h2 id="pythonç‰ˆ">Pythonç‰ˆ</h2>

<p>ä¹‹å‰çš„pythonç‰ˆä¸»è¦å®ç°åŠŸèƒ½æ˜¯åˆ©ç”¨opencvè·å–æœ€å¤§è¿é€šåŒºåŸŸå¹¶å»é™¤ã€‚å°†ä¹‹å‰åœ¨å°è±¡ç¬”è®°é‡Œå†™çš„è®°å½•æ‘˜æŠ„ä¸‹æ¥å¦‚ä¸‹:</p>

<p>ä¸»è¦ä½¿ç”¨äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<blockquote>
  <ul>
    <li>é¦–å…ˆé€šè¿‡findContourså‡½æ•°æ‰¾åˆ°äºŒå€¼å›¾åƒä¸­çš„æ‰€æœ‰è¾¹ç•Œ(è¿™å—çœ‹éœ€è¦è°ƒèŠ‚é‡Œé¢çš„å‚æ•°)</li>
    <li>ç„¶åé€šè¿‡contourAreaå‡½æ•°è®¡ç®—æ¯ä¸ªè¾¹ç•Œå†…çš„é¢ç§¯</li>
    <li>æœ€åé€šè¿‡fillConvexPolyå‡½æ•°å°†é¢ç§¯æœ€å¤§çš„è¾¹ç•Œå†…éƒ¨æ¶‚æˆèƒŒæ™¯</li>
  </ul>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="err">â€‹</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">imread</span><span class="p">(</span><span class="s">'bw.bmp'</span><span class="p">)</span>
    <span class="n">gray</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">cvtColor</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">COLOR_BGR2GRAY</span><span class="p">)</span>
<span class="err">â€‹</span>
    <span class="c1">#find contours of all the components and holes 
</span>    <span class="n">gray_temp</span> <span class="o">=</span> <span class="n">gray</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#copy the gray image because function
</span>                            <span class="c1">#findContours will change the imput image into another  
</span>    <span class="n">contours</span><span class="p">,</span> <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">cv2</span><span class="p">.</span><span class="n">findContours</span><span class="p">(</span><span class="n">gray_temp</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">RETR_TREE</span><span class="p">,</span> <span class="n">cv2</span><span class="p">.</span><span class="n">CHAIN_APPROX_NONE</span><span class="p">)</span>
<span class="err">â€‹</span>
    <span class="c1">#show the contours of the imput image
</span>    <span class="n">cv2</span><span class="p">.</span><span class="n">drawContours</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="s">'original image with contours'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s">'gray'</span><span class="p">)</span>
<span class="err">â€‹</span>
    <span class="c1">#find the max area of all the contours and fill it with 0
</span>    <span class="n">area</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contours</span><span class="p">)):</span>
        <span class="n">area</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">cv2</span><span class="p">.</span><span class="n">contourArea</span><span class="p">(</span><span class="n">contours</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="n">max_idx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
    <span class="n">cv2</span><span class="p">.</span><span class="n">fillConvexPoly</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">contours</span><span class="p">[</span><span class="n">max_idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="c1">#show image without max connect components 
</span>    <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="s">'remove max connect com'</span><span class="p">),</span> <span class="n">plt</span><span class="p">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">gray</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s">'gray'</span><span class="p">)</span>
<span class="err">â€‹</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div>

<p>ç»“æœå¦‚ä¸‹:</p>

<div class="fig figcenter">
    <img src="/blog/asssets/opencv_largest_connected_components/contours.png" />
    <div class="figcaption">src</div>
</div>

<div class="fig figcenter">
    <img src="/blog/asssets/opencv_largest_connected_components/result.png" />
    <div class="figcaption">å»é™¤æœ€å¤§è¿é€šåŸŸä¹‹åç»“æœ</div>
</div>

<p>åˆ†æä¸Šè¿°ç»“æœå¯ä»¥å‘ç°å­˜åœ¨ä¸¤ä¸ªé—®é¢˜:</p>
<ol>
  <li>ä½¿ç”¨findContourså‡½æ•°æ£€æµ‹è¾¹ç¼˜æ—¶å¦‚æœæœ€å¤§è¿é€šåŸŸå‡ºç°ä¸­ç©ºæƒ…å†µï¼Œåˆ™ç»“æœä¼šå°†ä¸­ç©ºçš„éƒ¨åˆ†å¡«å……ä¸Šï¼Œå¾—åˆ°é”™è¯¯çš„ç»“æœï¼Œæœ¬å›¾å› ä¸ºä¸­é—´æ²¡ç©ºï¼Œæ‰€ä»¥çœ‹èµ·æ¥æ•ˆæœæ˜¯å¯¹çš„ã€‚</li>
  <li>ä½¿ç”¨fillConvexPolyè¿™ä¸ªå‡½æ•°æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå¦‚æœæœ€å¤§è¿é€šåŸŸä¸æ˜¯å‡¸çš„ï¼Œåˆ™ä¼šå¾—åˆ°é”™è¯¯çš„å¡«å……ç»“æœã€‚</li>
</ol>

<h2 id="cç‰ˆ">c++ç‰ˆ</h2>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void findLargesrArea(Mat srcImage, Mat &amp;dstImage)
{
    vector&lt;vector&lt;Point&gt;&gt;	contours;
    vector&lt;Vec4i&gt;			hierarchy;

    findContours(srcImage.clone(), contours, hierarchy, CV_RETR_EXTERNAL, CV_CHAIN_APPROX_NONE);

    double max_area = 0;
    int index = 0;
    for(int i = 0; i &lt; contours.size(); i++) 
    {
        if(contourArea(contours[i]) &gt; max_area)
        {
            max_area = contourArea(contours[i]); 
            index = i;
        }
    }
    //cout &lt;&lt; "max_index: " &lt;&lt; index &lt;&lt; endl;

    dstImage =  Mat::zeros(srcImage.rows, srcImage.cols, srcImage.type()); 
    drawContours(dstImage, contours, index, Scalar(255));
    imfill(dstImage, dstImage);
}

void imfill(Mat srcimage, Mat &amp;dstimage)
{
    Size m_Size = srcimage.size();  
    Mat temimage = Mat::zeros(m_Size.height + 2, m_Size.width + 2, srcimage.type());

    srcimage.copyTo(temimage(Range(1, m_Size.height + 1), Range(1, m_Size.width + 1)));  
    floodFill(temimage, Point(0,0), Scalar(255)); 
    Mat cutImg;
    temimage(Range(1, m_Size.height + 1), Range(1, m_Size.width + 1)).copyTo(cutImg);  
    dstimage = srcimage | (~cutImg);  
}

</code></pre></div></div>
<p>c++è¿™ä¸ªç‰ˆæœ¬å­˜åœ¨ä¸Šè¿°ç¬¬1ä¸ªé—®é¢˜ï¼Œä½†æ˜¯ä¸å­˜åœ¨ç¬¬2ä¸ªé—®é¢˜ï¼ŒåŸå› æ˜¯å…¶ä½¿ç”¨äº†è‡ªå®šä¹‰çš„imfillå‡½æ•°ï¼Œé¿å…äº†å›¾åƒéå‡¸å‡ºç°é”™è¯¯çš„æƒ…å†µã€‚</p>

<h1 id="æ”¹è¿›çš„ç‰ˆæœ¬">æ”¹è¿›çš„ç‰ˆæœ¬</h1>

<h2 id="pythonç‰ˆ-1">Pythonç‰ˆ</h2>
<p>æœ€è¿‘å‘ç°å›¾åƒå¤„ç†åº“skimageå¾ˆå¥½ç”¨ï¼Œå› æ­¤ç”¨skimageå†™äº†ä¸€ä¸ªå‡½æ•°ç”¨äºæ ‡è®°æœ€å¤§è¿é€šåŸŸ:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">largestConnectComponent</span><span class="p">(</span><span class="n">bw_img</span><span class="p">,</span> <span class="p">):</span>
    <span class="s">'''
    compute largest Connect component of an labeled image
    
    Parameters:
    ---

    bw_img:
        binary image

    Example:
    ---
        &gt;&gt;&gt; lcc = largestConnectComponent(bw_img)

    '''</span>

    <span class="n">labeled_img</span><span class="p">,</span> <span class="n">num</span> <span class="o">=</span> <span class="n">label</span><span class="p">(</span><span class="n">bw_img</span><span class="p">,</span> <span class="n">neighbors</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">return_num</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>    
    <span class="c1"># plt.figure(), plt.imshow(labeled_img, 'gray')
</span>
    <span class="c1"># max_label = 0
</span>    <span class="n">max_label</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">max_num</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># è¿™é‡Œä»1å¼€å§‹ï¼Œé˜²æ­¢å°†èƒŒæ™¯è®¾ç½®ä¸ºæœ€å¤§è¿é€šåŸŸ
</span>        <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">labeled_img</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_num</span><span class="p">:</span>
            <span class="n">max_num</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span><span class="n">labeled_img</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">max_label</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">lcc</span> <span class="o">=</span> <span class="p">(</span><span class="n">labeled_img</span> <span class="o">==</span> <span class="n">max_label</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">lcc</span>

</code></pre></div></div>
<p><strong>æ³¨æ„(2018.10.10æ·»åŠ )</strong></p>

<p>æœ‰ä¸€æ¬¡æˆ‘åœ¨ä½¿ç”¨çš„æ—¶å€™å‘ç°æœ‰ä¸ªå‚æ•°è¿˜æŒºé‡è¦ï¼Œå°±æ˜¯è¿™ä¸ª<code class="language-plaintext highlighter-rouge">max_label</code>,å¦‚æœæŠŠå®ƒè®¾ç½®ä¸º0ï¼Œé‚£ä¹ˆå½“ä¸€å¼ å›¾åƒåªæœ‰ä¸€ä¸ªè¿é€šåŸŸçš„æ—¶å€™ï¼Œå…¶ç»“æœæ­£å¥½æ˜¯åŸå§‹å›¾åƒçš„åã€‚</p>

<p>æ£€æŸ¥ä»£ç å‘ç°åœ¨è¿™ä¸ªåœ°æ–¹:<code class="language-plaintext highlighter-rouge">lcc = (labeled_img == max_label)</code>.å¦‚æœåªæœ‰ä¸€ä¸ªæœ€å¤§è¿é€šåŸŸï¼Œé‚£ä¹ˆå‡½æ•°ä¸ä¼šæ‰§è¡Œ<code class="language-plaintext highlighter-rouge">for</code>å¾ªç¯ï¼Œç›´æ¥è¿›å…¥<code class="language-plaintext highlighter-rouge">lcc = (labeled_img == max_label)</code>,æ­¤æ—¶å¦‚æœ<code class="language-plaintext highlighter-rouge">max_label</code>å¦‚æœæ˜¯<code class="language-plaintext highlighter-rouge">0</code>ï¼Œåˆ™ä¼šç›´æ¥æŠŠèƒŒæ™¯å½“åšæœ€å¤§è¿é€šåŸŸäº†ï¼Œå› æ­¤å¿…é¡»æŠŠ<code class="language-plaintext highlighter-rouge">max_label</code>è®¾ç½®ä¸º1.</p>

<div class="fig figcenter">
    <img src="/blog/asssets/opencv_largest_connected_components/before.png" />
    <div class="figcaption">Before</div>
</div>

<div class="fig figcenter">
    <img src="/blog/asssets/opencv_largest_connected_components/0-after.png" />
    <div class="figcaption">max_labelä¸º0æ—¶ç»“æœ</div>
</div>

<div class="fig figcenter">
    <img src="/blog/asssets/opencv_largest_connected_components/1-after.png" />
    <div class="figcaption">max_labelä¸º1æ—¶ç»“æœ</div>
</div>

<h2 id="cç‰ˆ-1">c++ç‰ˆ</h2>
<p>ç”±äºopencv3ä¸­å¢åŠ äº†è¿é€šåŸŸæ ‡è®°å‡½æ•°ï¼Œå› æ­¤ä½¿å¾—æŸ¥æ‰¾æœ€å¤§è¿é€šåŸŸå˜å¾—æ›´åŠ å®¹æ˜“ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>void DefectsDetector::LargestConnecttedComponent(Mat srcImage, Mat &amp;dstImage)
{
    Mat temp;
    Mat labels;
    srcImage.copyTo(temp);

    //1. æ ‡è®°è¿é€šåŸŸ
    int n_comps = connectedComponents(temp, labels, 4, CV_16U);
    vector&lt;int&gt; histogram_of_labels;
    for (int i = 0; i &lt; n_comps; i++)//åˆå§‹åŒ–labelsçš„ä¸ªæ•°ä¸º0
    {
        histogram_of_labels.push_back(0);
    }

    int rows = labels.rows;
    int cols = labels.cols;
    for (int row = 0; row &lt; rows; row++) //è®¡ç®—æ¯ä¸ªlabelsçš„ä¸ªæ•°
    {
        for (int col = 0; col &lt; cols; col++)
        {
            histogram_of_labels.at(labels.at&lt;unsigned short&gt;(row, col)) += 1;
        }
    }
    histogram_of_labels.at(0) = 0; //å°†èƒŒæ™¯çš„labelsä¸ªæ•°è®¾ç½®ä¸º0

    //2. è®¡ç®—æœ€å¤§çš„è¿é€šåŸŸlabelsç´¢å¼•
    int maximum = 0;
    int max_idx = 0;
    for (int i = 0; i &lt; n_comps; i++)
    {
        if (histogram_of_labels.at(i) &gt; maximum)
        {
            maximum = histogram_of_labels.at(i);
            max_idx = i;
        }
    }

    //3. å°†æœ€å¤§è¿é€šåŸŸæ ‡è®°ä¸º1
    for (int row = 0; row &lt; rows; row++) 
    {
        for (int col = 0; col &lt; cols; col++)
        {
            if (labels.at&lt;unsigned short&gt;(row, col) == max_idx)
            {
                labels.at&lt;unsigned short&gt;(row, col) = 255;
            }
            else
            {
                labels.at&lt;unsigned short&gt;(row, col) = 0;
            }
        }
    }

    //4. å°†å›¾åƒæ›´æ”¹ä¸ºCV_8Uæ ¼å¼
    labels.convertTo(dstImage, CV_8U);
}
</code></pre></div></div>
:ET